<!DOCTYPE html>
<html>

<head>
    <script src="https://unpkg.com/konva@8.0.4/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"
        integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/"
        crossorigin="anonymous"></script>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <title>Vancerts Stage Designer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #ffffff;
        }

        #stage-parent {
            width: 100%;
        }

        #container {
            /* height: 3000px;  */
            /* background-image: url('assets/vanStage.png');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center; */
        }

        h4 {
            text-align: center;
        }

        #drag-items img {
            height: 50px;
        }

        #save {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        #set {
            position: absolute;
            top: 5px;
            right: 150px;
        }
    </style>
</head>

<body>
    <div id="stage-parent">
        <h4>Find your instruments to drag and drop into the stage area</h4>
        <div id="drag-items">
            <img src="/assets/guitar-icon-png-65.png" draggable="true" />
            <img src="/assets/guitar-bass-icon.png" draggable="true" />
            <img src="/assets/keyboard-icon.png" draggable="true" />
            <img src="assets/drum-icon.png" draggable="true" />
        </div>
        <div id="container"></div>
        <button id="save" type="button" class="btn btn-info">Save as PDF</button>
    </div>
    <script>
        var width = window.innerWidth;
        var height = window.innerHeight;

        var stage = new Konva.Stage({
            container: 'container',
            width: width,
            height: height,
        });
        var layer = new Konva.Layer();

        stage.add(layer);

        var imageObj = new Image();

        imageObj.onload = function () {
            var vanStage = new Konva.Image({
                x: 325,
                y: 50,
                image: imageObj,
                width: 600,
                height: 350,
            });

            // add the shape to the layer
            layer.add(vanStage);
        };
        imageObj.src = '/assets/vanStage.png';

        // what is url of dragging element?
        var itemURL = '';
        document
            .getElementById('drag-items')
            .addEventListener('dragstart', function (e) {
                itemURL = e.target.src;
            });

        // create transformer
        var tr = new Konva.Transformer();

        // create stage
        var con = stage.container();

        // initiate drag
        con.addEventListener('dragover', function (e) {
            e.preventDefault(); // !important
        });

        // add drop 
        con.addEventListener('drop', function (e) {
            e.preventDefault();
            // now we need to find pointer position
            // we can't use stage.getPointerPosition() here, because that event
            // is not registered by Konva.Stage
            // we can register it manually:
            stage.setPointersPositions(e);

            Konva.Image.fromURL(itemURL, function (image) {
                layer.add(image);

                image.position(stage.getPointerPosition());
                image.draggable(true);

                // get image size
                var size = image.size();
                var width = size.width;
                var height = size.height;

                // set size
                image.size({
                    width: 200,
                    height: 200
                });

                image.addEventListener('mouseover', function (e) {
                    // add transformer to layer
                    layer.add(tr);

                    // get transformer nodes
                    const nodes = tr.nodes();

                    // set transformer nodes
                    tr.nodes([image]);

                    // get transformer rotate
                    var rotateEnabled = tr.rotateEnabled();

                    // set transformer rotate
                    tr.rotateEnabled(true);
                });

                // remove transformer nodes 
                stage.on('click', function (e) {
                    tr.nodes([]);
                });
            });
        });

        document.getElementById('save').addEventListener('click', function () {
            // Code form KonvaJS wiki
            var pdf = new jsPDF('l', 'px', [stage.width(), stage.height()]);
            pdf.setTextColor('#000000');
            // first add texts
            stage.find('Text').forEach((text) => {
                const size = text.fontSize() / 0.75; // convert pixels to points
                pdf.setFontSize(size);
                pdf.text(text.text(), text.x(), text.y(), {
                    baseline: 'top',
                    angle: -text.getAbsoluteRotation(),
                });
            });

            // then put image on top of texts (so texts are not visible)
            pdf.addImage(
                stage.toDataURL({ pixelRatio: 2 }),
                0, 0, 900, 600
                // 0,
                // 0,
                // stage.width(),
                // stage.height()
            );

            pdf.save('stage-plot.pdf');
        });

        // REsponsive function not working
        function fitStageIntoParentContainer() {
                var container = document.querySelector('#stage-parent');

                // now we need to fit stage into parent container
                var containerWidth = container.offsetWidth;

                // but we also make the full scene visible
                // so we need to scale all objects on canvas
                var scale = containerWidth / sceneWidth;

                stage.width(sceneWidth * scale);
                stage.height(sceneHeight * scale);
                stage.scale({ x: scale, y: scale });
            }

        fitStageIntoParentContainer();
        // adapt the stage on any window resize
        window.addEventListener('resize', fitStageIntoParentContainer);
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
        crossorigin="anonymous"></script>
</body>

</html>